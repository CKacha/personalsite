---
import "../../styles/global.css";
import Topbar from "../../components/Topbar.astro";

import { getCollection, getEntry, render } from "astro:content";

const COLLECTION = "posts" as any;

export async function getStaticPaths() {

  const posts = await getCollection(COLLECTION);
  return posts.map((p: any) => ({
    params: { slug: p.slug as string },
  }));
}

const { slug } = Astro.params;

const entry = await getEntry(COLLECTION, slug);
if (!entry) {
  throw new Error(`Post not found: ${slug}`);
}

const { Content } = await render(entry);

const data = (entry as any).data as {
  title?: string;
  date?: Date | string;
  tags?: string[];
};

const title = data?.title ?? slug;
const date =
  data?.date instanceof Date ? data.date : new Date(String(data?.date ?? Date.now()));
const tags: string[] = Array.isArray(data?.tags) ? data!.tags! : [];
---

<html lang="en" data-theme="dark" data-base={import.meta.env.BASE_URL}>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{title} · alive</title>
  </head>
  <body>
    <Topbar />

    <main class="wrap">
      <h1 style="margin-bottom:4px">{title}</h1>
      <div class="repo-meta" style="margin-bottom:12px">
        <span>{date.toLocaleDateString()}</span>
        {tags.length > 0 && <span>{tags.map((t: string) => `#${t}`).join(" ")}</span>}
      </div>

      <article class="card">
        <Content />
      </article>

      <p style="margin-top:16px">
        <a class="tab" href={`${import.meta.env.BASE_URL}blog`}>← back to blog</a>
      </p>
    </main>

    <footer class="site-footer">made with astro + Need coffee</footer>
  </body>
</html>
